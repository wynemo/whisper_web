<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>File Upload, Selector, and WebSocket Viewer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f4f4f9;
                margin: 0;
                padding: 20px;
            }
            #output {
                white-space: pre-wrap;
                background: #1e1e1e;
                color: #dcdcdc;
                padding: 10px;
                border-radius: 5px;
                overflow-y: auto;
                height: 300px;
                margin-bottom: 20px;
            }
            button {
                margin: 5px 0;
                padding: 10px 15px;
                border: none;
                background-color: #0078d7;
                color: white;
                border-radius: 5px;
                cursor: pointer;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            select,
            input[type="file"] {
                width: 100%;
                padding: 10px;
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>
        <nav style="margin-bottom: 20px;">
            <a href="/" style="margin-right: 15px; color: #0078d7; text-decoration: none; font-weight: bold;">首页</a>
            <a href="srt-to-speech" style="margin-right: 15px; color: #0078d7; text-decoration: none;">SRT to Speech</a>
            <a href="tts-timeline" style="color: #0078d7; text-decoration: none;">TTS 时间轴</a>
        </nav>
        <h1>File Upload, Selector, and WebSocket Viewer</h1>

        <!-- 文件上传 -->
        <h2>Upload a File</h2>
        <input type="file" id="fileInput" />
        <button id="uploadBtn">Upload</button>

        <!-- 文件列表 -->
        <h2>Select a File to Process</h2>
        <select id="fileSelector">
            <option value="">Select a file...</option>
        </select>

        <!-- WebSocket 操作 -->
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>

        <div id="output"></div>

        <!-- 下载按钮区域 -->
        <div id="downloadSection" style="margin-top: 15px; display: none;">
            <h3>下载字幕</h3>
            <button id="downloadSrtBtn">下载 SRT 字幕</button>
            <button id="downloadTxtBtn">下载纯文本</button>
            <button id="copySrtBtn">复制 SRT</button>
            <button id="copyTxtBtn">复制纯文本</button>
        </div>

        <!-- SRT字幕预览区域 -->
        <div id="srtPreview" style="margin-top: 15px; display: none;">
            <h3>SRT 字幕预览 <button id="hideSrtBtn">隐藏</button></h3>
            <div id="srtText" style="white-space: pre-wrap; background: #fff; color: #333; padding: 10px; border-radius: 5px; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; font-family: monospace;"></div>
        </div>

        <script>
            const apiBaseUrl = window.location.origin; // 动态获取当前服务器的主机和端口
            let websocket = null;
            const outputDiv = document.getElementById("output");
            const connectBtn = document.getElementById("connectBtn");
            const disconnectBtn = document.getElementById("disconnectBtn");
            const fileSelector = document.getElementById("fileSelector");
            const fileInput = document.getElementById("fileInput");
            const uploadBtn = document.getElementById("uploadBtn");
            const downloadSection = document.getElementById("downloadSection");
            const downloadSrtBtn = document.getElementById("downloadSrtBtn");
            const downloadTxtBtn = document.getElementById("downloadTxtBtn");
            const copySrtBtn = document.getElementById("copySrtBtn");
            const copyTxtBtn = document.getElementById("copyTxtBtn");
            const srtPreview = document.getElementById("srtPreview");
            const srtText = document.getElementById("srtText");
            const hideSrtBtn = document.getElementById("hideSrtBtn");

            // 存储字幕数据
            let subtitleSegments = [];

            // 解析时间戳格式 [00:00:00,000 --> 00:00:05,000] 文本
            function parseSubtitleLine(line) {
                const match = line.match(/^\[(\d{2}:\d{2}:\d{2}[,\.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,\.]\d{3})\]\s*(.+)$/);
                if (match) {
                    return {
                        start: match[1].replace('.', ','),
                        end: match[2].replace('.', ','),
                        text: match[3]
                    };
                }
                return null;
            }

            // 生成标准SRT格式字幕
            function generateSrt() {
                let srt = '';
                subtitleSegments.forEach((seg, index) => {
                    srt += `${index + 1}\n`;
                    srt += `${seg.start} --> ${seg.end}\n`;
                    srt += `${seg.text}\n\n`;
                });
                return srt.trim();
            }

            // 生成纯文本字幕
            function generatePlainText() {
                return subtitleSegments.map(seg => seg.text).join('\n');
            }

            // 下载文件
            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function appendMessage(message) {
                const line = document.createElement("div");
                line.textContent = message;
                outputDiv.appendChild(line);
                outputDiv.scrollTop = outputDiv.scrollHeight; // 自动滚动到底部

                // 尝试解析字幕行
                const segment = parseSubtitleLine(message);
                if (segment) {
                    subtitleSegments.push(segment);
                }
            }

            async function loadFiles() {
                try {
                    const response = await fetch(`${apiBaseUrl}/files/`);
                    if (response.ok) {
                        const data = await response.json();
                        const files = data.files;
                        fileSelector.innerHTML =
                            '<option value="">Select a file...</option>';
                        files.forEach((file) => {
                            const option = document.createElement("option");
                            option.value = file;
                            option.textContent = file;
                            fileSelector.appendChild(option);
                        });
                    } else {
                        console.error("Failed to load files.");
                    }
                } catch (error) {
                    console.error("Error loading files:", error);
                }
            }

            connectBtn.addEventListener("click", () => {
                const selectedFile = fileSelector.value;
                if (!selectedFile) {
                    alert("Please select a file.");
                    return;
                }

                // 清空之前的数据
                subtitleSegments = [];
                outputDiv.innerHTML = '';
                downloadSection.style.display = 'none';
                srtPreview.style.display = 'none';

                if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                    websocket = new WebSocket(
                        `${apiBaseUrl.replace("http", "ws")}/ws`,
                    );

                    websocket.onopen = () => {
                        appendMessage(
                            `[Connected to WebSocket with file: ${selectedFile}]`,
                        );
                        websocket.send(selectedFile); // 发送选中的文件名
                        connectBtn.disabled = true;
                        disconnectBtn.disabled = false;
                    };

                    websocket.onmessage = (event) => {
                        appendMessage(event.data);
                        // 检测转录完成
                        if (event.data.includes("转录完成") || event.data.includes("SRT 文件已保存")) {
                            if (subtitleSegments.length > 0) {
                                downloadSection.style.display = 'block';
                                // 显示SRT预览
                                srtText.textContent = generateSrt();
                                srtPreview.style.display = 'block';
                            }
                        }
                    };

                    websocket.onclose = () => {
                        appendMessage("[WebSocket disconnected]");
                        connectBtn.disabled = false;
                        disconnectBtn.disabled = true;
                        // 转录完成后显示下载按钮
                        if (subtitleSegments.length > 0) {
                            downloadSection.style.display = 'block';
                            srtText.textContent = generateSrt();
                            srtPreview.style.display = 'block';
                        }
                    };

                    websocket.onerror = (error) => {
                        appendMessage("[WebSocket error]");
                        console.error("WebSocket error:", error);
                    };
                }
            });

            disconnectBtn.addEventListener("click", () => {
                if (websocket) {
                    websocket.close();
                    websocket = null;
                }
            });

            uploadBtn.addEventListener("click", async () => {
                const file = fileInput.files[0];
                if (!file) {
                    alert("Please select a file to upload.");
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);

                try {
                    const response = await fetch(`${apiBaseUrl}/upload/`, {
                        method: "POST",
                        body: formData,
                    });

                    if (response.ok) {
                        const data = await response.json();
                        appendMessage(`File uploaded: ${data.filename}`);
                        await loadFiles(); // 上传成功后刷新文件列表
                    } else {
                        appendMessage("Failed to upload file.");
                    }
                } catch (error) {
                    console.error("Error uploading file:", error);
                    appendMessage("Error uploading file.");
                }
            });

            // 下载SRT按钮
            downloadSrtBtn.addEventListener("click", () => {
                const srtContent = generateSrt();
                const filename = fileSelector.value ? fileSelector.value.replace(/\.[^/.]+$/, '.srt') : 'subtitles.srt';
                downloadFile(srtContent, filename, 'text/plain; charset=utf-8');
            });

            // 下载纯文本按钮
            downloadTxtBtn.addEventListener("click", () => {
                const txtContent = generatePlainText();
                const filename = fileSelector.value ? fileSelector.value.replace(/\.[^/.]+$/, '.txt') : 'subtitles.txt';
                downloadFile(txtContent, filename, 'text/plain; charset=utf-8');
            });

            // 复制SRT按钮
            copySrtBtn.addEventListener("click", () => {
                const srtContent = generateSrt();
                navigator.clipboard.writeText(srtContent).then(() => {
                    alert("SRT 字幕已复制到剪贴板");
                });
            });

            // 复制纯文本按钮
            copyTxtBtn.addEventListener("click", () => {
                const txtContent = generatePlainText();
                navigator.clipboard.writeText(txtContent).then(() => {
                    alert("纯文本已复制到剪贴板");
                });
            });

            // 隐藏预览按钮
            hideSrtBtn.addEventListener("click", () => {
                srtPreview.style.display = "none";
            });

            // 初始化文件列表
            loadFiles();
        </script>
    </body>
</html>
